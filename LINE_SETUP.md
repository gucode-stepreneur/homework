# คู่มือการตั้งค่า Line Messaging API

## ขั้นตอนการสร้าง Line Bot

### 1. สร้าง Line Bot Channel

1. ไปที่ [Line Developers Console](https://developers.line.biz/)
2. ล็อกอินด้วย Line Account
3. คลิก "Create New Provider" (หากยังไม่มี)
4. คลิก "Create Channel"
5. เลือก "Messaging API"
6. กรอกข้อมูล:
   - **Channel name**: ชื่อ Bot (เช่น "Homework Reminder")
   - **Channel description**: คำอธิบาย (เช่น "ระบบแจ้งเตือนการบ้าน")
   - **Category**: เลือกตามความเหมาะสม
   - **Subcategory**: เลือกตามความเหมาะสม
7. คลิก "Create"

### 2. ตั้งค่า Line Bot

1. หลังจากสร้าง Channel แล้ว ให้ไปที่ "Messaging API" tab
2. คัดลอก **Channel Access Token** (Long-lived)
3. เปิดใช้งาน **Use webhook** (ไม่จำเป็นสำหรับการส่งข้อความแบบ broadcast)
4. บันทึกการตั้งค่า

### 3. เพิ่ม Bot เป็นเพื่อน

1. ไปที่ "Messaging API" tab
2. คัดลอก **QR Code** หรือ **Line ID**
3. สแกน QR Code หรือค้นหา Line ID เพื่อเพิ่ม Bot เป็นเพื่อน

### 4. ข้อดีของการใช้ Broadcast

#### ข้อดี:
- **ไม่ต้องหา LINE_USER_ID** ของแต่ละคน
- **ส่งข้อความได้ง่าย** เพียงแค่แอด Bot เป็นเพื่อน
- **รองรับผู้ใช้หลายคน** โดยอัตโนมัติ
- **ไม่ต้องตั้งค่าเพิ่มเติม** สำหรับแต่ละผู้ใช้

#### วิธีการใช้งาน:
1. สร้าง Line Bot ตามขั้นตอนข้างต้น
2. แอด Line Bot เป็นเพื่อน
3. ตั้งค่า Channel Access Token ในไฟล์ .env
4. ระบบจะส่งข้อความไปยังทุกคนที่แอด Bot เป็นเพื่อน

### 5. ตั้งค่า Environment Variables

สร้างไฟล์ `.env` และเพิ่มการตั้งค่าดังนี้:

```env
# Line Messaging API Configuration
LINE_CHANNEL_ACCESS_TOKEN="your-channel-access-token-here"
```

**หมายเหตุ:** ไม่ต้องตั้งค่า LINE_USER_ID แล้ว เพราะระบบจะส่งข้อความไปยังทุกคนที่แอด Bot เป็นเพื่อน

## การทดสอบระบบ

### 1. ทดสอบการส่งข้อความ

1. ไปที่หน้า `/admin/notifications`
2. คลิกปุ่ม "ทดสอบการส่งข้อความ"
3. ตรวจสอบข้อความใน Line

### 2. ทดสอบ Cron Jobs

1. คลิกปุ่ม "เริ่มต้น Cron Jobs"
2. สร้างการบ้านที่มีกำหนดส่งในอนาคต
3. รอให้ระบบตรวจสอบและส่งข้อความ

## ตัวอย่างการตั้งค่า

### สำหรับ Line Messaging API:
```env
LINE_CHANNEL_ACCESS_TOKEN="U1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
```

## การแก้ไขปัญหา

### ปัญหา: ไม่ได้รับข้อความ
1. ตรวจสอบ Channel Access Token
2. ตรวจสอบว่าได้แอด Bot เป็นเพื่อนแล้ว
3. ตรวจสอบการตั้งค่า Webhook (หากใช้)

### ปัญหา: Error 401 Unauthorized
- ตรวจสอบ Channel Access Token ว่าถูกต้องหรือไม่

### ปัญหา: Error 403 Forbidden
- ตรวจสอบว่า Bot ยังเป็นเพื่อนอยู่หรือไม่
- ตรวจสอบสิทธิ์การส่งข้อความของ Bot

### ปัญหา: Error 429 Too Many Requests
- Line มีการจำกัดจำนวนข้อความที่ส่งได้
- รอสักครู่แล้วลองใหม่

## หมายเหตุสำคัญ

1. **Channel Access Token** ควรเก็บเป็นความลับ
2. ระบบจะส่งข้อความไปยังทุกคนที่แอด Bot เป็นเพื่อน
3. หากต้องการส่งให้เฉพาะบางคน ต้องใช้วิธีอื่น (เช่น Push Message)
4. Line มีการจำกัดจำนวนข้อความที่ส่งได้ (ประมาณ 1000 ข้อความต่อเดือน)
5. การใช้ Broadcast จะส่งข้อความไปยังทุกคนที่แอด Bot เป็นเพื่อน

## ทางเลือกอื่น

### Line Notify (แนะนำสำหรับการใช้งานง่าย)
- ไม่ต้องสร้าง Bot
- ส่งข้อความได้ง่าย
- มีการจำกัดน้อยกว่า

### Line Bot (แนะนำสำหรับการใช้งานขั้นสูง)
- สามารถสร้าง Bot ที่โต้ตอบได้
- มีฟีเจอร์มากกว่า
- เหมาะสำหรับการใช้งานเชิงพาณิชย์ 